# Claude Code 架构与工作流可视化

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     Claude Code 核心系统                      │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌────────────────────────────────────────────────────────┐ │
│  │              Context Engineering Engine                 │ │
│  │                  (上下文工程引擎)                         │ │
│  └────────────────────────────────────────────────────────┘ │
│                            ▲                                  │
│         ┌──────────────────┼──────────────────┐             │
│         │                  │                  │             │
│    ┌────▼────┐      ┌─────▼──────┐    ┌─────▼──────┐      │
│    │  Write  │      │   Select   │    │  Compress  │      │
│    │ Context │      │  Context   │    │  Context   │      │
│    │ (持久化) │      │  (检索)     │    │  (压缩)     │      │
│    └─────────┘      └────────────┘    └────────────┘      │
│                                                               │
│    ┌─────────────────────────────────────────────────┐     │
│    │           Isolate Context (隔离)                 │     │
│    │         Multi-Agent System (多代理)              │     │
│    └─────────────────────────────────────────────────┘     │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

---

## 📚 内存系统架构

```
内存层级结构
═══════════════════════════════════════════════════════════════

┌─────────────────────────────────────────────────────────────┐
│  Level 1: 用户全局内存 (User Memory)                         │
│  位置: ~/.claude/CLAUDE.md                                   │
│  作用域: 所有项目                                            │
│  内容: 个人编码偏好、快捷键、常用规则                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Level 2: 项目内存 (Project Memory)                          │
│  位置: ./CLAUDE.md                                           │
│  作用域: 当前项目                                            │
│  内容: 项目架构、技术栈、编码规范、团队约定                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│  Level 3: 专门内存 (Specialized Memory)                      │
│  位置: ./memory/*/CLAUDE.md                                  │
│  作用域: 特定领域                                            │
│  内容: 前端规范、后端API、数据库设计、测试策略                  │
└─────────────────────────────────────────────────────────────┘

加载顺序: Level 1 → Level 2 → Level 3
优先级: Level 3 > Level 2 > Level 1
```

---

## 🔄 工作流程图

### 基本对话流程

```
用户输入
   │
   ▼
┌──────────────────┐
│  上下文加载       │
│  - 用户内存      │
│  - 项目内存      │
│  - 对话历史      │
│  - 引用文件(@)   │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  模型推理        │
│  (Sonnet/Opus)  │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  工具调用        │
│  - read         │
│  - edit         │
│  - grep         │
│  - bash         │
│  - MCP tools    │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  输出格式化      │
│  (Output Style) │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│  Hooks 执行      │
│  (如需要)        │
└────────┬─────────┘
         │
         ▼
    返回结果
```

### 子代理工作流程

```
主代理 (Main Agent)
   │
   │ 检测到需要专门任务
   │
   ▼
┌──────────────────────────────────────┐
│  创建子代理实例                        │
│  - 加载子代理配置                     │
│  - 设置独立上下文                     │
│  - 限制可用工具                       │
└──────────────┬───────────────────────┘
               │
               ▼
     ┌─────────────────┐
     │  子代理工作      │
     │  (独立上下文)    │
     │                  │
     │  可能使用很多    │
     │  tokens 进行     │
     │  深度处理        │
     └────────┬─────────┘
              │
              ▼
     ┌─────────────────┐
     │  压缩结果        │
     │  (简洁的输出)    │
     └────────┬─────────┘
              │
              ▼
主代理 (接收简洁结果)
   │
   ▼
继续主对话
```

---

## 🎯 规划模式流程

```
Shift + Tab (进入规划模式)
           │
           ▼
┌──────────────────────┐
│   只读模式            │
│   - 不修改文件        │
│   - 可以搜索/阅读     │
│   - 可以研究/规划     │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│   创建详细计划        │
│   - 需求分析          │
│   - 架构设计          │
│   - 步骤分解          │
│   - 风险评估          │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│   用户审查/迭代       │
│   ◄───┐              │
│       │ 反馈循环      │
│   ────┘              │
└──────────┬───────────┘
           │
           │ 批准
           ▼
┌──────────────────────┐
│   退出规划模式        │
│   进入实施阶段        │
└──────────┬───────────┘
           │
           ▼
┌──────────────────────┐
│   按计划执行          │
│   - 修改代码          │
│   - 创建文件          │
│   - 运行命令          │
└──────────────────────┘
```

---

## 🔌 MCP 集成架构

```
┌─────────────────────────────────────────────────────────┐
│                    Claude Code                          │
└───────────────┬─────────────────────────────────────────┘
                │
                │ MCP Protocol
                │
    ┌───────────┴────────────┬──────────────┬───────────┐
    │                        │              │           │
    ▼                        ▼              ▼           ▼
┌────────┐            ┌──────────┐    ┌─────────┐  ┌──────┐
│Context7│            │Playwright│    │Database │  │Custom│
│  MCP   │            │   MCP    │    │   MCP   │  │ MCP  │
└────┬───┘            └────┬─────┘    └────┬────┘  └──┬───┘
     │                     │               │          │
     ▼                     ▼               ▼          ▼
┌────────────┐      ┌──────────┐    ┌──────────┐  ┌──────┐
│ 30K+ Libs  │      │ Browser  │    │ SQL      │  │ ...  │
│ Docs       │      │ Control  │    │ Queries  │  │      │
└────────────┘      └──────────┘    └──────────┘  └──────┘

配置文件: .mcp.json
权限管理: settings.local.json
```

---

## ⚙️ 配置系统层级

```
配置优先级 (从高到低)
═══════════════════════════════════════════════════════

┌────────────────────────────────────────────────────┐
│  Local Settings (本地配置) - 最高优先级              │
│  文件: .claude/settings.local.json                 │
│  作用: 个人本地覆盖，不提交到 Git                    │
│  用途: API keys, 临时配置, 本地工具路径              │
└──────────────────┬─────────────────────────────────┘
                   │ 覆盖
                   ▼
┌────────────────────────────────────────────────────┐
│  Project Settings (项目配置)                        │
│  文件: .claude/settings.json                       │
│  作用: 团队共享配置，提交到 Git                      │
│  用途: 项目特定工具, hooks, 代理配置                 │
└──────────────────┬─────────────────────────────────┘
                   │ 覆盖
                   ▼
┌────────────────────────────────────────────────────┐
│  User Settings (用户配置) - 最低优先级               │
│  文件: ~/.claude/settings.json                     │
│  作用: 全局个人配置                                  │
│  用途: 默认模型, 全局偏好, 主题                      │
└────────────────────────────────────────────────────┘
```

---

## 🎨 输出样式系统

```
用户请求
   │
   ▼
┌─────────────────┐
│ 检查当前样式     │
│ /output-style   │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  加载样式定义                        │
│                                      │
│  项目级: .claude/output-styles/     │
│          (优先)                      │
│             ↓                        │
│  用户级: ~/.claude/output-styles/   │
│          (后备)                      │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────┐
│ 应用样式规则     │
│ - 格式          │
│ - 语气          │
│ - 结构          │
│ - 工作流        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 生成响应        │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ 执行后处理       │
│ (如样式定义的    │
│  自动化步骤)     │
└─────────────────┘
```

---

## 🪝 Hooks 执行流程

```
工具调用触发
       │
       ▼
┌──────────────────┐
│  检查 Hooks 配置  │
└────────┬─────────┘
         │
    ┌────┴─────┐
    │          │
    ▼          ▼
Pre Hook    Post Hook
    │          │
    │          └─────────┐
    ▼                    │
┌─────────────┐          │
│  类型?       │          │
└──┬───────┬──┘          │
   │       │             │
   ▼       ▼             │
Command  Agent           │
   │       │             │
   │       ▼             │
   │  ┌──────────┐       │
   │  │ 启动     │       │
   │  │ 子代理   │       │
   │  └────┬─────┘       │
   │       │             │
   └───┬───┘             │
       │                 │
       ▼                 │
  执行工具               │
       │                 │
       └─────────────────┤
                         ▼
                    ┌─────────┐
                    │执行 Post │
                    │  Hook   │
                    └─────────┘
```

---

## 🐙 GitHub 集成架构

```
                GitHub 仓库
                     │
         ┌───────────┼───────────┐
         │           │           │
         ▼           ▼           ▼
      Issue        Pull       Comment
                 Request
         │           │           │
         └───────────┴───────────┘
                     │
                 @claude 提及
                     │
                     ▼
         ┌──────────────────────┐
         │  GitHub Actions       │
         │  Workflow 触发        │
         └──────────┬────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │  Claude Code 启动     │
         │  - 加载 CLAUDE.md    │
         │  - 读取 Issue 内容   │
         │  - 分析仓库代码      │
         └──────────┬────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │  执行任务             │
         │  - 修改代码          │
         │  - 运行测试          │
         │  - 自我审查          │
         └──────────┬────────────┘
                    │
                    ▼
         ┌──────────────────────┐
         │  创建/更新 PR         │
         │  - 提交更改          │
         │  - 添加评论          │
         │  - 请求审查          │
         └──────────────────────┘
```

---

## 🚀 并行开发架构

```
项目目录 (共享 Git 仓库)
        │
        ├─── .git/
        ├─── .claude/
        │    ├─── CLAUDE.md (共享)
        │    ├─── commands/
        │    ├─── agents/
        │    └─── settings.json
        │
        └─── src/
             ├─── components/
             ├─── pages/
             └─── utils/

┌────────────────────────┐    ┌────────────────────────┐
│   终端 1                │    │   终端 2                │
│   Claude 实例 A         │    │   Claude 实例 B         │
├────────────────────────┤    ├────────────────────────┤
│   工作目录: ./project  │    │   工作目录: ./project  │
│                        │    │                        │
│   任务: 重构组件 A      │    │   任务: 创建页面 B      │
│                        │    │                        │
│   ✅ 独立文件           │    │   ✅ 独立文件           │
│   ✅ 无依赖关系         │    │   ✅ 无依赖关系         │
│                        │    │                        │
│   共享上下文:          │    │   共享上下文:          │
│   - CLAUDE.md         │    │   - CLAUDE.md         │
│   - 项目配置           │    │   - 项目配置           │
└────────────────────────┘    └────────────────────────┘
             │                            │
             └────────────┬───────────────┘
                          │
                          ▼
                 共享 Git 状态
                 (可能产生冲突)
```

---

## 🔐 权限与安全架构

```
┌─────────────────────────────────────────────────────┐
│              安全层级 (从外到内)                      │
└─────────────────────────────────────────────────────┘

    ┌────────────────────────────────────────────┐
    │  Workspace Trust (工作区信任)              │
    │  - 限制 Claude 只能访问特定目录             │
    │  - 启动时验证                               │
    └──────────────────┬─────────────────────────┘
                       │
                       ▼
    ┌────────────────────────────────────────────┐
    │  Tool Permissions (工具权限)               │
    │  - allowed-tools 白名单                    │
    │  - 最小权限原则                             │
    └──────────────────┬─────────────────────────┘
                       │
                       ▼
    ┌────────────────────────────────────────────┐
    │  Sandboxing (沙箱)                         │
    │  - 隔离代码执行                             │
    │  - 限制系统调用                             │
    └──────────────────┬─────────────────────────┘
                       │
                       ▼
    ┌────────────────────────────────────────────┐
    │  User Review (用户审查)                     │
    │  - 关键操作需要确认                         │
    │  - 显示将要执行的操作                       │
    └────────────────────────────────────────────┘
```

---

## 📊 上下文管理策略

```
上下文窗口管理
═══════════════════════════════════════════════════════

初始状态 (Token: 0)
    │
    ▼
加载基础上下文
├─ 系统提示 (固定)
├─ 用户内存 (~/.claude/CLAUDE.md)
├─ 项目内存 (./CLAUDE.md)
└─ 输出样式 (如启用)
    │ Token: ~5K
    ▼
┌─────────────────────────────────────────┐
│         对话进行中                        │
│                                          │
│  每轮对话:                               │
│  + 用户消息 (~100-1K tokens)            │
│  + AI 响应 (~500-3K tokens)             │
│  + 工具使用结果 (~100-5K tokens)         │
│                                          │
│  Token 逐渐增长...                       │
└───────────┬─────────────────────────────┘
            │
            │ 当 Token > 阈值
            ▼
┌─────────────────────────────────────────┐
│    上下文压缩策略                         │
│                                          │
│  选项 1: /compact                        │
│  - 总结对话历史                          │
│  - 保留关键决策                          │
│  - Token: ~50K → ~5K                    │
│                                          │
│  选项 2: /clear                          │
│  - 清空对话历史                          │
│  - 保留项目内存                          │
│  - Token: ~50K → ~3K                    │
│                                          │
│  选项 3: 使用子代理                       │
│  - 隔离复杂任务                          │
│  - 仅返回简洁结果                        │
│  - 主上下文增长最小                      │
└─────────────────────────────────────────┘
```

---

## 🎓 学习路径可视化

```
Claude Code 学习路径
═══════════════════════════════════════════════════════

第1阶段: 基础入门 (第 1-2 天)
┌─────────────────────────────────────┐
│ ✓ 安装配置                          │
│ ✓ 基本对话                          │
│ ✓ /init 初始化                      │
│ ✓ 理解 CLAUDE.md                    │
└──────────┬──────────────────────────┘
           │
           ▼
第2阶段: 核心概念 (第 3-5 天)
┌─────────────────────────────────────┐
│ ✓ Context Engineering               │
│ ✓ 内存系统                          │
│ ✓ @引用和#快捷键                     │
│ ✓ 斜杠命令                          │
└──────────┬──────────────────────────┘
           │
           ▼
第3阶段: 自定义功能 (第 6-10 天)
┌─────────────────────────────────────┐
│ ✓ 自定义命令                        │
│ ✓ 输出样式                          │
│ ✓ MCP 集成                          │
│ ✓ 规划模式                          │
└──────────┬──────────────────────────┘
           │
           ▼
第4阶段: 高级特性 (第 11-15 天)
┌─────────────────────────────────────┐
│ ✓ 子代理                            │
│ ✓ Hooks 自动化                      │
│ ✓ 并行实例                          │
│ ✓ 规格驱动开发                       │
└──────────┬──────────────────────────┘
           │
           ▼
第5阶段: 团队协作 (第 16-20 天)
┌─────────────────────────────────────┐
│ ✓ GitHub 集成                       │
│ ✓ 团队配置                          │
│ ✓ 最佳实践                          │
│ ✓ 优化工作流                        │
└──────────┬──────────────────────────┘
           │
           ▼
    🎓 Claude Code 专家
```

---

## 🎯 核心概念关系图

```
                 Claude Code
                      │
        ┌─────────────┼─────────────┐
        │             │             │
        ▼             ▼             ▼
    Context      Memory         Tools
   Engineering   System
        │             │             │
        │             │             ├─ 内置工具
        │             │             ├─ MCP
        │             │             └─ 自定义命令
        │             │
        │             ├─ 用户内存
        │             ├─ 项目内存
        │             └─ 专门内存
        │
        ├─ Write Context
        ├─ Select Context
        ├─ Compress Context
        └─ Isolate Context
               │
               ▼
           Subagents ─────┬─────── Output Styles
               │          │              │
               │          │              │
               │          ▼              │
               │       Hooks             │
               │          │              │
               └──────────┴──────────────┘
                          │
                          ▼
                   Automation Workflow
```

---

## 💡 快速决策树

```
开始新任务
    │
    ▼
  任务是否复杂?
    │
    ├─ 是 → 使用规划模式 (Shift+Tab)
    │        │
    │        ▼
    │      创建详细计划
    │        │
    │        ▼
    │      审查并迭代
    │        │
    │        ▼
    │      批准执行
    │
    └─ 否 → 直接对话
             │
             ▼
       是否需要特定上下文?
             │
             ├─ 是 → 使用 @引用
             │        @memory/spec/CLAUDE.md
             │
             └─ 否 → 依赖自动加载
                      │
                      ▼
                 是否需要专门处理?
                      │
                      ├─ 是 → 调用子代理
                      │        代码审查/测试/文档
                      │
                      └─ 否 → 普通对话
                               │
                               ▼
                          是否需要特定格式?
                               │
                               ├─ 是 → 切换输出样式
                               │        /output-style
                               │
                               └─ 否 → 使用默认样式
```

---

## 🔄 典型开发循环

```
一天的开发工作流
═══════════════════════════════════════════════════════

08:00 - 启动
    ↓
    cd project && claude
    检查 /cost 昨日使用
    │
09:00 - 晨间规划
    ↓
    Shift+Tab (规划模式)
    回顾任务列表
    制定今日计划
    │
10:00 - 实施功能
    ↓
    根据 @memory/spec/CLAUDE.md 实施
    使用子代理进行代码审查
    │
12:00 - 提交代码
    ↓
    /commit 生成提交信息
    git push
    │
13:00 - 午休后继续
    ↓
    /compact 压缩上午的对话
    开始下午的任务
    │
15:00 - 并行开发
    ↓
    开启第二个 Claude 实例
    并行处理独立任务
    │
17:00 - 代码审查
    ↓
    调用代码审查子代理
    处理审查建议
    │
18:00 - 收尾
    ↓
    更新 CLAUDE.md (如有新约定)
    提交所有更改
    关闭 Claude
```

---

这个架构图展示了 Claude Code 的完整系统结构和工作流程，帮助你从宏观角度理解各个组件如何协同工作！

